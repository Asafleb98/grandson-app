<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> </title>
    <style>
        :root {
            --primary-color: #007AFF;
            --success-color: #34C759;
            --bg-color: #F2F2F7;
            --text-color: #1C1C1E;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { 
            width: 100%;
            max-width: 600px;
            background: white; 
            padding: 30px; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin-top: 20px;
        }
        
        h1 { font-size: 2.2rem; margin-bottom: 5px; color: #333; }
        p { font-size: 1.2rem; color: #666; margin-bottom: 30px; }

        /* 驻转专 */
        .buttons-row { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            align-items: center;
        }

        .big-button {
            border: none; 
            color: white; 
            width: 100%; 
            max-width: 350px;
            height: 90px;
            font-size: 1.6rem;
            font-weight: bold;
            border-radius: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 15px;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .mic-btn { background-color: var(--primary-color); }
        .cam-btn { background-color: var(--success-color); }
        .big-button:active { transform: scale(0.96); }

        /* --- 爪转 拽砖 () --- */
        .listening-waves {
            display: none;
            margin: 20px auto;
            height: 40px;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .bar {
            width: 6px;
            background-color: #FF3B30;
            border-radius: 4px;
            animation: sound 0.6s infinite ease-in-out alternate;
        }
        .bar:nth-child(2) { animation-delay: 0.2s; height: 25px; }
        .bar:nth-child(3) { animation-delay: 0.4s; height: 40px; }
        
        @keyframes sound {
            0% { height: 10px; opacity: 0.5; }
            100% { height: 50px; opacity: 1; }
        }

        /* --- 爪转 砖 (拽转 拽驻爪转) --- */
        .thinking-dots {
            display: none; /* 住转专 专专转  */
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 25px;
        }
        
        .dot {
            width: 15px;
            height: 15px;
            background-color: var(--primary-color);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        #status { 
            margin-top: 15px; 
            font-size: 1.3rem; 
            color: #888; 
            min-height: 25px; 
            font-weight: 500;
        }
        
        #response-area {
            margin-top: 20px; 
            font-size: 1.6rem;
            line-height: 1.4;
            color: #1C1C1E; 
            background: #E5F1FF; 
            padding: 20px; 
            border-radius: 15px; 
            display: none;
            border-right: 5px solid var(--primary-color);
            text-align: right;
        }

        #preview { 
            max-width: 100%; 
            margin-top: 20px; 
            border-radius: 15px; 
            display: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>  </h1>
    <p>爪 注 驻转专 专 转</p>
    
    <div class="buttons-row">
        <button id="micBtn" class="big-button mic-btn" onclick="startListening()">
            <span></span>  拽砖
        </button>

        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(this)">
        <button class="big-button cam-btn" onclick="document.getElementById('cameraInput').click()">
            <span></span> 转专 
        </button>
    </div>

    <div id="listening-indicator" class="listening-waves">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>

    <div id="thinking-indicator" class="thinking-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
    
    <img id="preview" src="" alt="Image preview">
    <div id="status"></div>
    <div id="response-area"></div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const responseDiv = document.getElementById('response-area');
    const previewImg = document.getElementById('preview');
    const waves = document.getElementById('listening-indicator');
    const dots = document.getElementById('thinking-indicator');

    // Wake Lock
    let wakeLock = null;
    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } 
        catch (err) { console.log(err); }
    }

    // --- Speech Logic ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'he-IL'; 
    
    recognition.onstart = () => { 
        statusDiv.innerText = " 拽砖 ..."; 
        waves.style.display = 'flex'; 
        dots.style.display = 'none'; // 住转专转 爪转 砖  转
        responseDiv.style.display = 'none';
        requestWakeLock(); 
    };

    recognition.onend = () => { 
        statusDiv.innerText = ""; 
        waves.style.display = 'none'; 
    };

    recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        statusDiv.innerText = "砖注转: " + text;
        sendToBackend(text, null);
    };

    function startListening() { recognition.start(); }

    // --- Camera Logic ---
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            statusDiv.innerText = "注 转...";
            requestWakeLock();
            
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                sendToBackend(" 注砖 注 ?", e.target.result);
            }
            reader.readAsDataURL(file); 
        }
    }

    // --- Backend & Audio Logic ---
    async function sendToBackend(text, imageBase64) {
        // 1. 住转专转 转砖 砖
        responseDiv.style.display = 'none';
        
        // 2. 爪转  砖
        statusDiv.innerText = " 砖...";
        dots.style.display = 'flex'; // 驻注 转 拽转 拽驻爪转
        
        window.speechSynthesis.cancel(); 

        try {
            const res = await fetch('/api/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userMessage: text, image: imageBase64 }) 
            });

            const data = await res.json();
            
            // 3. 拽 转砖 -  转 拽转
            dots.style.display = 'none';
            statusDiv.innerText = "";

            // 4. 爪 转 转砖
            responseDiv.style.display = 'block';
            responseDiv.innerText = data.answer;
            
            if (data.audio) {
                const audio = new Audio("data:audio/mp3;base64," + data.audio);
                audio.play();
            }
        } catch (error) {
            console.error(error);
            dots.style.display = 'none';
            responseDiv.innerText = "砖 转拽 专.";
            responseDiv.style.display = 'block';
        }
    }
</script>

</body>
</html>