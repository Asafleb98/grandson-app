<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> </title>
    <style>
        :root { 
            --primary-color: #007AFF; 
            --success-color: #34C759; 
            --bg-color: #F2F2F7; 
            --text-color: #1C1C1E; 
            --recording-color: #FF3B30; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; 
            user-select: none; -webkit-user-select: none;
        }

        .container { 
            width: 100%; max-width: 600px; 
            background: white; padding: 30px; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center; margin-top: 20px; 
        }

        h1 { font-size: 2.2rem; margin-bottom: 5px; color: #333; }
        p { font-size: 1.2rem; color: #666; margin-bottom: 30px; }
        
        .buttons-row { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%; }
        
        .big-button { 
            border: none; color: white; width: 100%; max-width: 350px; height: 90px; 
            font-size: 1.6rem; font-weight: bold; border-radius: 20px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 15px; 
            transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
            touch-action: manipulation;
        }
        
        .mic-btn { background-color: var(--primary-color); }
        .mic-btn.recording { background-color: var(--recording-color); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .cam-btn { background-color: var(--success-color); }
        .cam-btn:active { transform: scale(0.96); }
        
        #response-area { 
            margin-top: 20px; font-size: 1.6rem; line-height: 1.4; 
            color: #1C1C1E; background: #E5F1FF; padding: 20px; 
            border-radius: 15px; display: none; 
            border-right: 5px solid var(--primary-color); text-align: right; 
        }

        .thinking-dots { display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 25px; margin-bottom: 25px; }
        .dot { width: 15px; height: 15px; background-color: var(--primary-color); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        #status { margin-top: 15px; font-size: 1.3rem; color: #888; min-height: 25px; font-weight: 500;}
        #preview { max-width: 100%; margin-top: 20px; border-radius: 15px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .admin-link { display: inline-block; margin-top: 30px; color: #999; text-decoration: none; font-size: 0.9rem; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h1>  </h1>
    <p>爪 驻注 转  专, 驻注 砖 住</p>
    
    <div class="buttons-row">
        <button id="micBtn" class="big-button mic-btn" onclick="toggleRecording()"><span></span> 爪 专</button>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(this)">
        <button class="big-button cam-btn" onclick="openCamera()"><span></span> 转专 </button>
    </div>

    <div id="thinking-indicator" class="thinking-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <img id="preview" src="" alt="Image preview">
    <div id="status"></div>
    <div id="response-area"></div>
    <a href="/admin.html" class="admin-link">锔 注专转 驻专驻 </a>
</div>

<script>
    // --- 爪专转  砖  专注  ---
    //  驻注 砖专注, 住驻专  砖转 砖专转 拽 "祝 拽"
    const sessionId = Date.now().toString() + Math.random().toString(36).substring(7);
    console.log("Current Session ID:", sessionId);

    const statusDiv = document.getElementById('status'); 
    const responseDiv = document.getElementById('response-area');
    const previewImg = document.getElementById('preview');
    const dots = document.getElementById('thinking-indicator');
    const micBtn = document.getElementById('micBtn');
    const audioPlayer = new Audio();
    let wakeLock = null;
    let isRecording = false;
    let finalTranscript = ""; 

    async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); }}

    function toggleRecording() {
        if (!isRecording) startRecord();
        else stopAndSend();
    }

    function startRecord() {
        isRecording = true;
        finalTranscript = ""; 
        micBtn.classList.add('recording'); 
        micBtn.innerHTML = "<span>癸</span> 住转 专"; 
        responseDiv.style.display = 'none';
        statusDiv.innerText = " 拽砖...";
        audioPlayer.src = 'data:audio/mp3;base64,'; audioPlayer.play().catch(() => {});
        try { recognition.start(); } catch (err) { console.log("Already started"); }
    }

    function stopAndSend() {
        isRecording = false;
        micBtn.classList.remove('recording'); 
        micBtn.innerHTML = "<span></span> 爪 专";
        try { recognition.stop(); } catch(err) { console.log(err); }
        if (finalTranscript.trim().length > 0) sendToBackend(finalTranscript, null);
        else statusDiv.innerText = " 砖注转 , 住 砖.";
    }

    function openCamera() {
        audioPlayer.src = 'data:audio/mp3;base64,'; audioPlayer.play().catch(() => {});
        document.getElementById('cameraInput').click();
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition(); 
    recognition.lang = 'he-IL'; 
    recognition.interimResults = true; 
    recognition.continuous = true;     
    
    recognition.onstart = () => { requestWakeLock(); };
    recognition.onresult = (e) => { 
        let interimTranscript = '';
        for (let i = e.resultIndex; i < e.results.length; ++i) {
            if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript;
            else interimTranscript += e.results[i][0].transcript;
        }
        statusDiv.innerText = "砖注: " + finalTranscript + interimTranscript; 
        if (!finalTranscript && interimTranscript) finalTranscript = interimTranscript;
    };

    function handleImageUpload(input) { 
        if (input.files && input.files[0]) { 
            const file = input.files[0]; 
            const reader = new FileReader(); 
            statusDiv.innerText = "注 转..."; dots.style.display = 'flex'; 
            reader.onload = function(e) { 
                previewImg.src = e.target.result; previewImg.style.display = 'block'; 
                sendToBackend(" 注砖 注 ?", e.target.result); 
            }; 
            reader.readAsDataURL(file); 
        }
    }

    async function sendToBackend(text, imageBase64) {
        responseDiv.style.display = 'none'; statusDiv.innerText = " 砖..."; dots.style.display = 'flex'; 
        audioPlayer.pause(); audioPlayer.currentTime = 0;

        try {
            // 砖 转 -sessionId 砖专转
            const res = await fetch('/api/ask', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ userMessage: text, image: imageBase64, sessionId: sessionId }) 
            });
            const data = await res.json();
            dots.style.display = 'none'; statusDiv.innerText = ""; 
            responseDiv.style.display = 'block'; responseDiv.innerText = data.answer; 
            if (data.audio) { audioPlayer.src = "data:audio/mp3;base64," + data.audio; audioPlayer.play().catch(e => console.error("Play error:", e)); }
        } catch (error) { 
            console.error(error); dots.style.display = 'none'; 
            responseDiv.innerText = "砖 转拽 专."; responseDiv.style.display = 'block'; 
        }
    }
</script>
</body>
</html>